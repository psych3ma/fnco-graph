# CTO 관점 영향도·사이드이펙트 검토 (협업코드 고려)

최근 반영된 변경(Neo4j CTO 5항목 + 초기 그래프 limit)에 대한 **영향도**, **사이드이펙트**, **협업/유지보수** 관점 정리.

---

## 1. 변경 요약

| # | 변경 내용 | 주요 파일 |
|---|-----------|-----------|
| (1) | 최대주주 지분율: 관계 데이터 기반 계산 | `panel-manager.js` |
| (2) | 노드 선택 시 해당 노드+연결만 fit | `graph-manager.js` |
| (3) | 연결노드: 투자방향 제거, 투자비율 내림차순 | `panel-manager.js` |
| (4) | self-loop 노드 초기 그래프 제외 | `app.js` |
| (5) | 자동검색: 검색어 포함 노드만 제안 | `app.js` |
| (6) | 초기 그래프 조회 limit 100→1000 (관계 행) | `app.js`, `constants.js`, `database.py` |

---

## 2. 영향도

### 2.1 (1) 최대주주 지분율 — 관계 기반 계산

- **영향 범위**: 노드 상세 패널의 "최대주주 지분율" 숫자.
- **동작**: `connectedNodes`의 `pct`(stockRatio) 중 **최댓값**을 사용. 관계에 숫자가 없으면 기존 `nodeProps.maxStockRatio`(또는 첫 링크) fallback.
- **의존성**:
  - **노드 상세 API** `get_node_detail` → `get_node_relationships(..., limit=50)`.  
    관계가 50건을 넘으면 **최대주주 지분율은 “상위 50건 관계 중 최대”**가 됨. 진짜 전체 최대와 다를 수 있음(일반적으로 50이면 충분하지만, 주주 수가 매우 많은 노드는 이론상 차이 가능).
- **협업**: `nodeProps.maxStockRatio`는 이제 “관계 없을 때만” 사용. 백엔드에서 해당 필드를 제거해도 fallback만 더 쓰일 뿐 동작은 유지.

### 2.2 (2) 노드 선택 시 fit

- **영향 범위**: 노드 클릭/검색 결과 선택 시 뷰 포커스.
- **동작**: `network.fit({ nodes: [nodeId, ...getConnectedNodes(nodeId)] })`로 선택 노드와 연결 노드만 화면에 맞춤.
- **엣지 케이스**:
  - 연결 0개: `fitNodeIds = [nodeId]` → 한 노드만 확대. 문제 없음.
  - 연결 매우 많음(수백): fit 시 줌 아웃되어 작게 보일 수 있음. 의도된 동작.
- **협업**: `zoomFit()`(전체 보기)는 그대로. 기존 “focus + scale 1.3” 제거로, “선택 시 항상 연결만 fit”으로 동작이 통일됨.

### 2.3 (3) 연결노드: 투자방향 제거, 투자비율 내림차순

- **영향 범위**: 노드 상세의 "연결 노드" 리스트.
- **동작**: "투자→"/"←투자" 제거, `pct` 기준 내림차순 정렬, 비율만 표시(예: `5.3%`).
- **사이드이펙트**:
  - **CSS**: `.ri-edge-label` 클래스는 더 이상 HTML에서 사용하지 않음. 스타일은 그대로 두어도 동작에는 영향 없음(오프된 스타일). 정리 시 제거 가능.
  - **접근성/의미**: “방향” 정보가 빠짐. 필요 시 `aria-label` 등에 "투자 방향: 들어옴/나감" 정도만 보강 가능(선택).

### 2.4 (4) self-loop 노드 초기 그래프 제외

- **영향 범위**: 초기 로드 시 `graphNodes` 필터.
- **동작**: `edge.source === edge.target` 인 엣지의 양 끝 노드 ID를 모아, 해당 노드는 초기 그래프에서 제외. 검색 결과에는 그대로 노출.
- **사이드이펙트**:
  - **검색 후 선택**: self-loop만 있는 노드를 검색해서 선택하면, 해당 노드가 **초기 그래프에 없어** `visNodes.get(nodeId)`가 없을 수 있음. 이 경우 `focusNode()`가 early return하여 포커스/이동이 안 됨.  
    → “직접 검색 시에만 표출”은 “검색 제안에만 보인다” 수준으로 동작하며, “선택 시 그래프에 추가해 포커스”는 별도 구현(ego 그래프 로드 등)이 필요.
- **협업**: `shCountExcluded`와 동일한 필터 체인에 추가된 것이라, 다른 필터 로직과 충돌 없음.

### 2.5 (5) 자동검색: 검색어 포함 노드만 제안

- **영향 범위**: 검색 입력 시 드롭다운 제안 목록.
- **동작**: `displayName` / `companyName` / `stockName` / `id` 중 검색어(대소문자 무시) **포함**인 노드만 표시.
- **사이드이펙트**:
  - **정규화/유사 검색**: 한글 초성, 띄어쓰기 차이, 동음이의 등은 그대로. 백엔드가 CONTAINS 기반이면 기존과 동일하고, 프론트에서 한 번 더 잘라서 “완전히 무관한” 결과만 제거하는 효과.
  - **빈 결과**: 모두 필터링되면 제안이 0개. 이미 `relevantNodes.length === 0`일 때 드롭다운 닫도록 처리됨.

### 2.6 (6) 초기 그래프 limit 100 → 1000

- **영향 범위**: 첫 로드 시 `/api/graph?limit=...` 요청 및 이후 노드/엣지 수.
- **동작**: `INITIAL_GRAPH_EDGE_LIMIT = 1000`으로 관계 행 1000건까지 조회 → 그에 등장하는 노드만 표시.
- **사이드이펙트**:
  - **응답 크기·시간**: 1000건이면 100건 대비 페이로드·Neo4j 응답 시간 증가. 백엔드 `MAX_QUERY_LIMIT=1000` 이내이므로 허용된 범위.
  - **프론트 성능**: 노드/엣지 수 증가로 vis-network 렌더 비용 증가. 수천 노드 수준은 일반적으로 감당 가능. 이후 노드 수가 더 커지면 가상화/샘플링 검토.
  - **통계와의 차이**: 좌측 “노드 유형” 건수는 `get_statistics()`(전체 DB) 기준이라, 화면에 보이는 노드 수와는 다름. “보이는 것 = 샘플”로 이해하면 됨.

---

## 3. 교차 영향·호환성

| 구분 | 내용 |
|------|------|
| **nd-stats** | 최대주주 지분율은 (1)에 의해 관계 기반 값으로 표시. 주주 수는 기존 그대로. |
| **연결 노드 2개 + 더보기** | (3)에서 정렬만 내림차순, 표시 개수·더보기 로직은 변경 없음. |
| **주주수 0/'-' 제외** | (4)의 self-loop 제외와 동일 필터 파이프라인에 추가. 순서: shCount 제외 → self-loop 제외 → graphNodes. |
| **API 호환** | 백엔드 시그니처/응답 스키마 변경 없음. 프론트만 사용 방식 변경. |

---

## 4. 권장 사항 (협업·유지보수)

1. **문서화**  
   - `NODE_PROPERTIES_DISPLAY_SPEC.md` 또는 기존 Neo4j 리뷰 문서에 “최대주주 지분율은 노드 상세 조회 시 관계(최대 50건) 기반으로 계산” 명시 시, 향후 데이터 기대값 논의 시 유리.

2. **노드 상세 관계 limit(50)**  
   - 주주 수가 매우 많은 노드에서 “진짜 최대 지분”과 다를 수 있음. 필요 시 백엔드에서 `get_node_relationships`의 limit 상향 또는 “지분 최대 1건만 가져오는” 전용 쿼리 검토.

3. **Self-loop 노드 검색 후 선택**  
   - “직접 검색 시에만 표출”을 “검색 후 선택하면 그래프에 추가하고 포커스”까지 확장하려면, 검색 결과 선택 시 해당 노드(및 ego 등)를 로드해 `rawNodes`/`rawLinks`에 merge한 뒤 `buildGraph` 호출하는 플로우 추가 필요.

4. **CSS 정리**  
   - `.ri-edge-label`는 미사용 클래스. 레이아웃/접근성에 영향 없음. 정리 시 제거해도 됨.

5. **초기 limit 튜닝**  
   - `INITIAL_GRAPH_EDGE_LIMIT`는 `constants.js`에 있으므로, 환경(데이터 크기·네트워크)에 따라 500/1000 등으로 조정 가능. 백엔드 `MAX_QUERY_LIMIT` 초과 불가.

---

## 5. 요약

- **기능적**: (1)~(6) 모두 기존 플로우와 호환되며, API/백엔드 스키마 변경 없음.
- **리스크**:  
  - (1) 관계 50건 제한으로 인한 최대 지분 편차(극단적 케이스),  
  - (4) self-loop만 있는 노드 검색 후 선택 시 포커스 미동작,  
  - (6) 초기 1000건 로드 시 응답/렌더 부하 증가 가능성.
- **협업**: 상수·주석으로 “관계 행 limit = 표시 노드 다양도”와 “최대주주 지분 = 관계 기반”이 명시되어 있어, 이후 인수인계·튜닝 시 혼동을 줄일 수 있음.

위 항목들을 인지한 상태로 배포·모니터링하면 되고, 필요 시 4장 권장 사항만 단계적으로 반영하면 됩니다.
