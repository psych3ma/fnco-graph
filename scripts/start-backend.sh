#!/usr/bin/env bash
# 백엔드 서버 시작 스크립트
# 포트 충돌 자동 감지 및 해결
# 백엔드 전문가 CTO 관점에서 개선된 버전
# zsh 호환성 고려

set -e

# zsh에서 bash 모드로 실행되도록 보장
if [ -n "$ZSH_VERSION" ]; then
    emulate -L bash
fi

# 포트 설정 (환경 변수 또는 기본값)
PORT=${API_PORT:-8000}
BACKEND_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
BACKEND_PATH="$BACKEND_DIR/backend"

# 색상 출력
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${GREEN}🚀 백엔드 서버 시작 중...${NC}"
echo ""

# 사전 체크 실행 (선택사항, 비대화형 모드에서는 건너뜀)
if [ -t 0 ] && [ -f "$BACKEND_DIR/../scripts/verify-backend-setup.sh" ]; then
    echo -e "${YELLOW}사전 체크를 실행하시겠습니까? (y/N)${NC}"
    read -t 5 -p "" -n 1 -r 2>/dev/null || REPLY="n"
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        # bash로 명시적 실행 (zsh 호환성)
        /usr/bin/env bash "$BACKEND_DIR/../scripts/verify-backend-setup.sh"
        CHECK_EXIT=$?
        if [ $CHECK_EXIT -ne 0 ]; then
            echo -e "${RED}사전 체크 실패. 계속 진행하시겠습니까? (y/N)${NC}"
            read -p "" -n 1 -r
            echo
            if [[ ! $REPLY =~ ^[Yy]$ ]]; then
                exit 1
            fi
        fi
        echo ""
    fi
fi

# 포트 사용 확인 함수 (개선된 버전)
# LISTEN 상태뿐만 아니라 CLOSED, TIME_WAIT 등 모든 상태 확인
check_port() {
    # LISTEN 상태 확인
    if lsof -Pi :$PORT -sTCP:LISTEN -t >/dev/null 2>&1; then
        return 0  # 포트 사용 중 (LISTEN)
    fi
    
    # CLOSED, TIME_WAIT 등 다른 상태도 확인
    if lsof -i :$PORT -t >/dev/null 2>&1; then
        return 0  # 포트 사용 중 (다른 상태)
    fi
    
    return 1  # 포트 사용 가능
}

# 포트를 사용하는 모든 프로세스 찾기 및 종료
cleanup_port() {
    local cleaned=false
    
    # LISTEN 상태 프로세스
    local listen_pids=$(lsof -Pi :$PORT -sTCP:LISTEN -t 2>/dev/null || echo "")
    if [ -n "$listen_pids" ]; then
        for pid in $listen_pids; do
            echo -e "${YELLOW}   LISTEN 상태 프로세스 종료 중: PID $pid${NC}"
            kill -9 $pid 2>/dev/null || true
            cleaned=true
        done
    fi
    
    # CLOSED/TIME_WAIT 등 다른 상태 프로세스
    local all_pids=$(lsof -i :$PORT -t 2>/dev/null | grep -v "^$listen_pids$" || echo "")
    if [ -n "$all_pids" ]; then
        for pid in $all_pids; do
            echo -e "${YELLOW}   포트 점유 프로세스 종료 중: PID $pid${NC}"
            kill -9 $pid 2>/dev/null || true
            cleaned=true
        done
    fi
    
    if [ "$cleaned" = "true" ]; then
        sleep 2  # 프로세스 종료 대기
        return 0
    fi
    
    return 1
}

# 포트 확인 및 처리 (사용자 친화적 버전)
if check_port; then
    echo ""
    echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━END}${NC}"
    echo ""
    echo -e "${RED}⚠️  문제 발견: 포트 ${PORT}번이 이미 사용 중입니다!${NC}"
    echo ""
    echo -e "${YELLOW}📋 현재 상황:${NC}"
    echo -e "   • 포트 번호: ${BLUE}${PORT}${NC}"
    echo -e "   • 문제: 다른 프로그램이 이 포트를 사용하고 있어서 서버를 시작할 수 없습니다"
    echo ""
    
    # 포트를 사용하는 프로세스 정보를 읽기 쉽게 표시
    echo -e "${YELLOW}🔍 포트를 사용하는 프로그램:${NC}"
    ALL_PIDS=$(lsof -i :$PORT -t 2>/dev/null || echo "")
    
    if [ -n "$ALL_PIDS" ]; then
        for PID in $ALL_PIDS; do
            PROCESS_NAME=$(ps -p $PID -o comm= 2>/dev/null || echo "알 수 없음")
            PROCESS_CMD=$(ps -p $PID -o args= 2>/dev/null | head -c 80 || echo "알 수 없음")
            echo -e "   ${RED}•${NC} 프로그램: ${BLUE}${PROCESS_NAME}${NC}"
            echo -e "     프로세스 ID: ${BLUE}${PID}${NC}"
            echo -e "     실행 명령: ${BLUE}${PROCESS_CMD}...${NC}"
        done
    else
        echo -e "   ${YELLOW}프로세스 정보를 가져올 수 없습니다${NC}"
    fi
    
    echo ""
    echo -e "${YELLOW}💡 해결 방법:${NC}"
    echo -e "   이 프로그램을 종료하면 서버를 시작할 수 있습니다."
    echo ""
    
    # 자동 종료 옵션 (환경 변수로 제어 가능)
    AUTO_KILL=${AUTO_KILL:-false}
    
    if [ "$AUTO_KILL" = "true" ]; then
        echo -e "${GREEN}   자동으로 프로그램을 종료하고 서버를 시작합니다...${NC}"
        cleanup_port
    else
        # 사용자 확인 (더 명확한 메시지)
        if [ -t 0 ]; then
            echo -e "${GREEN}   위 프로그램을 종료하고 서버를 시작하시겠습니까?${NC}"
            echo -e "${YELLOW}   (y = 종료하고 시작, N = 취소)${NC}"
            read -p "   입력: " -n 1 -r
            echo ""
            if [[ $REPLY =~ ^[Yy]$ ]]; then
                echo ""
                echo -e "${GREEN}   프로그램 종료 중...${NC}"
                cleanup_port
                echo -e "${GREEN}   ✅ 완료! 서버를 시작합니다.${NC}"
            else
                echo ""
                echo -e "${RED}❌ 취소되었습니다.${NC}"
                echo ""
                echo -e "${YELLOW}다음 중 하나를 선택하세요:${NC}"
                echo -e "   1. 수동으로 종료: ${BLUE}./scripts/stop-backend.sh${NC}"
                echo -e "   2. 다른 포트 사용: 스크립트의 PORT 변수 변경"
                exit 1
            fi
        else
            # 비대화형 모드에서는 자동 종료
            echo -e "${GREEN}   비대화형 모드: 프로그램 자동 종료 중...${NC}"
            cleanup_port
        fi
    fi
    
    # 종료 확인 (재확인)
    sleep 1
    if check_port; then
        echo -e "${RED}❌ 프로세스 종료 실패. 수동으로 확인해주세요.${NC}"
        echo -e "${YELLOW}   명령어: lsof -i :$PORT${NC}"
        echo -e "${YELLOW}   또는: ./scripts/stop-backend.sh${NC}"
        exit 1
    else
        echo -e "${GREEN}✅ 포트 $PORT이 해제되었습니다.${NC}"
    fi
fi

# 서버 시작 직전 최종 포트 확인 (race condition 방지)
echo -e "${BLUE}🔍 서버 시작 전 최종 포트 확인...${NC}"
if check_port; then
    echo -e "${RED}❌ 포트 $PORT이 여전히 사용 중입니다.${NC}"
    echo -e "${YELLOW}   잠시 후 다시 시도하거나 ./scripts/stop-backend.sh를 실행하세요.${NC}"
    exit 1
fi

# 가상 환경 확인 (선택사항)
# 프로젝트 루트 또는 backend 디렉토리에서 venv 찾기
VENV_PATH=""
if [ -d "$BACKEND_DIR/venv" ]; then
    VENV_PATH="$BACKEND_DIR/venv"
elif [ -d "$BACKEND_PATH/venv" ]; then
    VENV_PATH="$BACKEND_PATH/venv"
fi

if [ -n "$VENV_PATH" ]; then
    echo -e "${GREEN}📦 가상 환경 활성화: $VENV_PATH${NC}"
    source "$VENV_PATH/bin/activate"
fi

# Python 모듈 경로 확인
if [ ! -f "$BACKEND_PATH/main.py" ]; then
    echo -e "${RED}❌ main.py를 찾을 수 없습니다: $BACKEND_PATH/main.py${NC}"
    exit 1
fi

# 프로젝트 루트로 이동 (상대 import를 위해 필요)
cd "$BACKEND_DIR"

# PYTHONPATH 설정 (협업 코드 고려: 명시적 경로 설정)
export PYTHONPATH="$BACKEND_DIR:$PYTHONPATH"

# 서버 시작
echo -e "${GREEN}✅ 포트 $PORT 사용 가능${NC}"
echo -e "${GREEN}🌐 서버 시작: http://localhost:$PORT${NC}"
echo -e "${GREEN}📚 API 문서: http://localhost:$PORT/docs${NC}"
echo -e "${YELLOW}   종료하려면 Ctrl+C를 누르세요${NC}"
echo ""

# uvicorn 실행 (프로젝트 루트에서 backend.main:app으로 실행)
# 상대 import를 사용하므로 패키지 경로로 실행해야 함
# 포트 충돌은 이미 사전에 처리했으므로, 여기서는 일반적인 에러만 처리
if ! uvicorn backend.main:app --reload --host 0.0.0.0 --port $PORT 2>&1; then
    EXIT_CODE=$?
    echo ""
    echo -e "${RED}❌ 서버 시작 실패 (종료 코드: $EXIT_CODE)${NC}"
    echo ""
    
    # 포트 충돌 에러인지 확인 (에러 코드 또는 실제 포트 사용 확인)
    if [ $EXIT_CODE -eq 48 ] || [ $EXIT_CODE -eq 1 ]; then
        # 실제로 포트가 사용 중인지 확인
        if check_port; then
            echo -e "${YELLOW}포트 충돌이 발생했습니다.${NC}"
            echo -e "${YELLOW}   포트를 점유하는 프로세스를 확인합니다...${NC}"
            PORT_INFO=$(lsof -i :$PORT 2>/dev/null || echo "")
            if [ -n "$PORT_INFO" ]; then
                echo -e "${BLUE}$PORT_INFO${NC}"
            fi
            
            echo -e "${YELLOW}   포트를 정리하시겠습니까? (y/N)${NC}"
            if [ -t 0 ]; then
                read -p "   " -n 1 -r
                echo
                if [[ $REPLY =~ ^[Yy]$ ]]; then
                    cleanup_port
                    echo -e "${GREEN}✅ 포트 정리 완료.${NC}"
                    echo -e "${YELLOW}   다음 명령어로 다시 시도하세요:${NC}"
                    echo -e "${BLUE}   ./scripts/start-backend.sh${NC}"
                else
                    echo -e "${YELLOW}   수동 정리: ./scripts/stop-backend.sh${NC}"
                fi
            else
                # 비대화형 모드에서는 자동 정리
                cleanup_port
                echo -e "${GREEN}✅ 포트 정리 완료.${NC}"
            fi
        fi
    fi
    
    # ImportError 체크 (상대 import 문제)
    if echo "$EXIT_CODE" | grep -q "ImportError\|attempted relative import" || [ $EXIT_CODE -ne 0 ]; then
        # 에러 메시지에서 ImportError 확인
        if [ $EXIT_CODE -ne 48 ] && [ $EXIT_CODE -ne 1 ]; then
            echo ""
            echo -e "${YELLOW}문제 해결 방법:${NC}"
            echo -e "${BLUE}1. ImportError인 경우: 스크립트가 자동으로 수정되었습니다. 다시 실행해보세요.${NC}"
            echo -e "${BLUE}2. 포트 충돌 해결: ./scripts/stop-backend.sh${NC}"
            echo -e "${BLUE}3. 의존성 확인: pip install -r requirements.txt${NC}"
            echo -e "${BLUE}4. 환경 변수 확인: .env 파일 확인${NC}"
            echo -e "${BLUE}5. 사전 체크 실행: ./scripts/verify-backend-setup.sh${NC}"
            echo -e "${BLUE}6. 로그 확인: 위의 에러 메시지 확인${NC}"
        fi
    fi
    
    # 포트 충돌이 아닌 경우
    if ! check_port; then
        echo -e "${YELLOW}문제 해결 방법:${NC}"
        echo -e "${BLUE}1. 포트 충돌 해결: ./scripts/stop-backend.sh${NC}"
        echo -e "${BLUE}2. 의존성 확인: pip install -r requirements.txt${NC}"
        echo -e "${BLUE}3. 환경 변수 확인: .env 파일 확인${NC}"
        echo -e "${BLUE}4. 사전 체크 실행: ./scripts/verify-backend-setup.sh${NC}"
        echo -e "${BLUE}5. 로그 확인: 위의 에러 메시지 확인${NC}"
    fi
    
    exit $EXIT_CODE
fi
